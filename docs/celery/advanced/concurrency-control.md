# 並發控制

並發控制是 Celery 的一種進階功能，允許您限制工作者同時處理的任務數量，避免資源過載與系統崩潰。本文將介紹並發控制的配置與應用場景。

## 什麼是並發控制？

並發控制是指通過設置參數，控制每個工作者同時執行的任務數量（即並發度）。這有助於在資源有限的環境中防止過載，確保系統穩定性。

- **作用**：限制工作者並發任務數量，保護系統資源。
- **應用場景**：伺服器資源有限，或任務執行可能導致高 CPU/記憶體使用時。

## 並發控制配置

Celery 提供多種方式控制並發度，包括工作者級別與任務級別的限制。

### 工作者級別並發控制

通過啟動工作者時設置 `--concurrency` 參數，限制每個工作者進程的並發任務數：
```bash
# 限制每個工作者進程同時處理 4 個任務
celery -A app worker --loglevel=info --concurrency=4
```

- **--concurrency**：設置工作者進程的並發度，預設值通常與 CPU 核心數相關。

### 使用進程池控制

Celery 支援多種並發模型，常用的是 `prefork` 進程池，可以通過配置進一步限制：
```bash
# 使用 prefork 模型，限制並發度為 2
celery -A app worker --loglevel=info --pool=prefork --concurrency=2
```

- **--pool=prefork**：使用進程池模型，適合 CPU 密集型任務。
- 其他模型包括 `solo`（單進程）、`threads`（線程池）等，根據任務性質選擇。

### 任務級別速率限制

Celery 還支援為特定任務設置速率限制（每秒執行次數），避免過頻繁執行：
```python
@app.task(rate_limit='10/m')  # 每分鐘最多 10 次
def rate_limited_task(data):
    return process_data(data)
```

- **rate_limit**：設置任務執行速率，如 `10/m`（每分鐘 10 次）、`5/s`（每秒 5 次）。

## 應用場景

- **資源受限環境**：在低配伺服器上運行 Celery，限制並發度以避免崩潰。
  ```bash
  celery -A app worker --concurrency=2
  ```
- **API 調用限制**：避免過頻繁調用外部 API，設置速率限制。
  ```python
  @app.task(rate_limit='100/h')  # 每小時 100 次
  def call_external_api():
      pass
  ```
- **任務性質差異**：為 CPU 密集型任務設置低並發度，為 I/O 密集型任務設置高並發度。

## 注意事項

- **並發度設置**：過低可能導致任務堆積，過高可能導致資源耗盡，需根據伺服器能力與任務性質調整。
- **並發模型選擇**：CPU 密集型任務適合 `prefork`，I/O 密集型任務可考慮 `threads` 或 `gevent`。
- **監控與調整**：使用監控工具觀察系統資源使用，動態調整並發參數。

## 小結

並發控制是 Celery 保護系統資源與確保穩定性的重要功能，通過合理設置並發度與速率限制，您可以避免資源過載，提升系統可靠性。下一章節，我們將介紹「遠程調用（RPC）」，探索如何以同步風格處理異步任務結果。

> **提示**：並發控制應結合實際系統負載與任務特性測試調整，避免一刀切的設置。
